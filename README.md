# Telegram 频道消息转发工具

这是一个基于 Pyrogram 的 Telegram 频道消息转发工具，能够自动从指定频道获取消息并将其转发到一个或多个目标频道。支持视频缩略图生成和自定义媒体组上传功能。

## 功能特点

- 支持从公开频道和私有频道获取消息
- 支持指定消息 ID 范围的精确转发
- 支持向多个目标频道同时转发
- 支持多种消息类型（文本、图片、视频、文档等）
- 支持视频自动生成缩略图并保存
- 支持 SOCKS5/SOCKS4 代理设置
- 自动处理连接中断和重试
- 完善的日志记录系统
- 媒体文件压缩优化和批量上传功能

## 使用方法

1. 复制`config_example.ini`为`config.ini`并填写相关配置
2. 运行`python main.py`开始转发

## 安装依赖

```bash
pip install -r requirements.txt
# 如需使用图片优化功能，还需安装：
pip install pillow
```

## 转发流程详解

整个消息转发流程如下：

1. **初始化阶段**：
   - 读取配置文件，验证API参数和频道设置
   - 连接到Telegram服务器，验证频道是否存在和权限
   - 创建必要的临时目录和日志文件

2. **消息获取阶段**：
   - 从源频道获取指定范围内的消息
   - 按批次获取消息，避免API限制
   - 对获取的消息进行筛选（根据配置跳过某些类型）

3. **媒体处理阶段**：
   - 检测消息是否包含媒体文件
   - 如果需要，下载媒体文件到本地临时目录
   - 为视频生成缩略图（如果启用）
   - 对图片进行优化处理（如果启用）

4. **转发阶段**：
   - 首先发送到第一个目标频道
   - 检测第一个频道是否允许转发
   - 如果允许，从第一个频道转发到其他频道
   - 如果不允许，寻找其他可转发的频道或直接逐个发送

5. **并行处理**：
   - 一次处理多个媒体组以提高效率
   - 使用进度条显示总体进度和当前文件进度
   - 自动处理API限制和延迟

6. **异常处理**：
   - 自动重试网络错误或API限制
   - 记录详细日志以便调试
   - 在中断时提供恢复选项

## 配置项详细说明

配置文件（config.ini）包含以下各个部分的设置项：

### [API] - Telegram API 设置

| 配置项         | 说明              | 取值范围                                | 默认值    |
| -------------- | ----------------- | --------------------------------------- | --------- |
| `api_id`       | Telegram API ID   | 整数，从 https://my.telegram.org 获取   | 无，必填  |
| `api_hash`     | Telegram API Hash | 字符串，从 https://my.telegram.org 获取 | 无，必填  |
| `phone_number` | 账号电话号码      | 字符串，带国家代码（如+8613800138000）  | 空 (可选) |

### [PROXY] - 代理设置

| 配置项       | 说明           | 取值范围                   | 默认值      |
| ------------ | -------------- | -------------------------- | ----------- |
| `enabled`    | 是否启用代理   | `True` 或 `False`          | `False`     |
| `proxy_type` | 代理类型       | `SOCKS5`、`SOCKS4`、`HTTP` | `SOCKS5`    |
| `addr`       | 代理服务器地址 | IP 地址或域名              | `127.0.0.1` |
| `port`       | 代理服务器端口 | 1-65535                    | `1080`      |
| `username`   | 代理认证用户名 | 字符串                     | 空 (可选)   |
| `password`   | 代理认证密码   | 字符串                     | 空 (可选)   |

### [CHANNELS] - 频道设置

| 配置项            | 说明         | 取值范围                    | 默认值   |
| ----------------- | ------------ | --------------------------- | -------- |
| `source_channel`  | 源频道标识符 | 频道链接、用户名(@xxx)或 ID | 无，必填 |
| `target_channels` | 目标频道列表 | 逗号分隔的多个频道标识符    | 无，必填 |

### [FORWARD] - 转发设置

| 配置项                | 说明                    | 取值范围             | 默认值  |
| --------------------- | ----------------------- | -------------------- | ------- |
| `start_message_id`    | 起始消息 ID             | 整数，0 表示自动选择 | `0`     |
| `end_message_id`      | 结束消息 ID             | 整数，0 表示最新消息 | `0`     |
| `hide_author`         | 是否隐藏原作者          | `True` 或 `False`    | `False` |
| `delay`               | 消息间转发延迟(秒)      | 浮点数，≥0           | `1.0`   |
| `batch_size`          | 每批获取的消息数量      | 整数，1-100          | `50`    |
| `skip_emoji_messages` | 是否跳过含 emoji 的消息 | `True` 或 `False`    | `False` |

### [MEDIA] - 媒体设置

| 配置项              | 说明                    | 取值范围          | 默认值  |
| ------------------- | ----------------------- | ----------------- | ------- |
| `skip_media`        | 是否跳过媒体文件        | `True` 或 `False` | `False` |
| `enable_thumbnails` | 是否启用视频缩略图生成   | `True` 或 `False` | `True`  |

### [DOWNLOAD] - 下载设置

| 配置项        | 说明               | 取值范围             | 默认值 |
| ------------- | ------------------ | -------------------- | ------ |
| `temp_folder` | 临时文件存储文件夹 | 有效文件路径         | `temp` |
| `timeout`     | 下载超时时间(秒)   | 整数，≥1             | `300`  |
| `chunk_size`  | 下载分块大小(字节) | 整数，推荐 4096-8192 | `4096` |
| `enabled`     | 是否启用媒体下载   | `True` 或 `False`    | `True` |

### [UPLOAD] - 上传设置

| 配置项                   | 说明                   | 取值范围            | 默认值   |
| ------------------------ | ---------------------- | ------------------- | -------- |
| `enabled`                | 是否启用媒体上传       | `True` 或 `False`   | `True`   |
| `upload_after_forward`   | 是否在转发后上传       | `True` 或 `False`   | `True`   |
| `optimize_images`        | 是否优化图片以加快上传 | `True` 或 `False`   | `True`   |
| `max_image_size`         | 图片最大尺寸(像素)     | 整数，建议 800-2000 | `1280`   |
| `image_quality`          | 图片保存质量           | 整数，1-100         | `85`     |
| `max_concurrent_batches` | 最大并发上传批次数     | 整数，建议 1-5      | `3`      |
| `thumbnail_folder`       | 缩略图保存文件夹       | 有效文件路径        | `pic`    |

### [LOG] - 日志设置

| 配置项  | 说明         | 取值范围                                        | 默认值         |
| ------- | ------------ | ----------------------------------------------- | -------------- |
| `level` | 日志级别     | `DEBUG`、`INFO`、`WARNING`、`ERROR`、`CRITICAL` | `INFO`         |
| `file`  | 日志文件路径 | 有效文件路径                                    | `logs/app.log` |

## 视频缩略图功能

当 `enable_thumbnails` 设置为 `True` 时，程序会为所有视频文件自动生成缩略图：

1. 从视频中提取时长 25% 位置的帧作为缩略图
2. 将缩略图调整到符合 Telegram 要求的尺寸（不超过 320 像素）
3. 优化缩略图质量，确保大小不超过 200KB
4. 缩略图会用于 Telegram 上传，同时保存在本地指定文件夹中

**缩略图保存规则**：
- 缩略图会保存在 `thumbnail_folder` 指定的文件夹中（默认为 `pic`）
- 文件名格式为：`{原视频文件名}_{时间戳}.jpg`
- 缩略图大小不超过 320 像素，同时保持原视频比例

**注意事项**：
- 此功能需要安装 moviepy 和 Pillow 库
- 如果 moviepy 未安装，程序会自动降级（不生成缩略图）
- 生成缩略图会略微增加处理时间，但显著提升用户体验

## 图片优化说明

当 `optimize_images` 设置为 `True` 时，程序会在上传前对图片进行优化，具体优化方式为：

1. 限制图片的最大尺寸（由 `max_image_size` 控制）
2. 调整图片的保存质量（由 `image_quality` 控制）

这可以大幅提高上传速度，减少网络带宽使用。如果您的网络速度较慢，建议启用此功能。

## 批量上传说明

程序支持批量上传媒体文件，并可通过 `max_concurrent_batches` 控制并发上传的批次数：

1. 媒体文件会按每 10 个一组进行分批
2. 每批并发上传到所有目标频道
3. 最多同时处理 `max_concurrent_batches` 个批次

通过增加并发批次数可以提高上传速度，但也会增加网络和服务器负载。

## 常见问题解决

1. **导入错误: moviepy.editor**
   - 安装 moviepy 库: `pip install moviepy`
   - 如果安装后仍有问题，IDE 可能显示错误但程序仍能运行
   - 可以使用 `# type: ignore` 注释来解决 IDE 警告

2. **缩略图生成失败**
   - 检查是否安装了 moviepy 和 Pillow
   - 确保视频文件格式受支持（MP4, AVI, MOV 等常见格式）
   - 尝试更新 ffmpeg: `pip install imageio-ffmpeg --upgrade`

3. **上传速度慢**
   - 增加 `max_concurrent_batches` 值（建议不超过 5）
   - 启用图片优化功能 (`optimize_images=True`)
   - 使用代理服务器提高连接速度（如有可用代理）
